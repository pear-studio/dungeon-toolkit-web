## Context

角色创建向导（`/create`）是本平台的核心功能，当前已实现种族、职业、属性、背景、描述五个步骤的基础框架，但存在：
- 数据层不完整：职业特性、背景特性文本、初始物品均为占位符或缺失
- 交互逻辑缺失：技能熟练选择、亚种族强制选择、多职业/等级配置均未实现
- 无最终产出：向导结束后没有角色卡预览，用户无法确认结果

本次变更横跨数据层（JSON 解析脚本、Django 模型）、API 层（DRF 序列化器）和前端（React 组件与 Zustand Store），属于典型的跨层全栈变更。

## Goals / Non-Goals

**Goals:**
- 补全所有职业、背景、物品的规则数据（从 `rules_source/` 解析）
- 重构 `wizardStore` 支持多职业、初始等级、技能熟练、装备字段
- 实现技能熟练选择 UI（职业步骤）
- 实现亚种族强制选择并传播属性加成
- 展示背景初始物品包（固定展示，无需玩家做选择）
- 最终步骤生成只读角色卡预览
- 所有数据严格从 `rules_source/DND5e_chm/玩家手册` 读取

**Non-Goals:**
- 不实现法术选择（另立变更）
- 不实现装备商店购买（本次只展示背景初始物品包）
- 不实现角色保存/分享（角色创建提交流程已有）
- 不覆盖 PHB 2024 新规则（本次仅处理 2014 版）

## Decisions

### D1：物品数据分层存储

**决策**：新建 `items.json` 作为物品信息库（独立于 `backgrounds.json`）；`backgrounds.json` 中 `starting_equipment` 字段存储物品 slug 列表，前端通过 slug 关联显示详细信息。

**备选方案**：直接在 `backgrounds.json` 内嵌物品详细数据。

**拒绝原因**：内嵌会导致同一物品（如「探索家包」）在多个背景中重复存储，维护成本高；slug 引用保证了单一来源。

---

### D2：多职业状态结构

**决策**：`wizardStore` 中将职业由单个 `class_slug` 改为职业条目数组：
```ts
classes: Array<{ class_slug: string; level: number }>
```
总等级 = 各条目 level 之和（上限 20）。

**备选方案**：保留单职业字段，另增 `multiclass` 数组。

**拒绝原因**：双字段结构增加同步复杂度，单一数组更简洁，主职业 = `classes[0]`。

---

### D3：技能熟练的计算来源

**决策**：最终技能熟练集合 = 职业提供的选择 ∪ 背景固定技能。计算在前端 `wizardStore` 的 selector 中完成，不上传后端重新计算。

**备选方案**：提交时由后端计算并返回。

**拒绝原因**：创建向导是纯前端交互，实时反馈更重要；后端校验在提交时进行即可。

---

### D4：背景初始物品展示方式

**决策**：玩家手册中背景的初始物品是固定给予的（没有选择项），因此 UI 只做**展示**，不做选择交互。直接在背景详情卡片中列出物品名和简短描述。

**背景**：玩家手册 p.125 描述背景物品包为固定内容，与职业初始装备（二选一）不同。本次仅处理背景物品包。

---

### D5：属性步骤重构方向

**决策**：属性步骤分为两个子面板：① 选择分配方式并设定初始六项原始值；② 基于原始值 + 种族/亚种族加成显示最终属性总览（只读）。两个面板在同一步骤内纵向排列，无需切换标签。

**拒绝方案**：拆为两个独立步骤。**拒绝原因**：步骤数已较多，合并更流畅。

---

### D6：职业特性数据结构

**决策**：`classes.json` 中每个职业新增 `features` 字段，为按等级组织的特性列表：
```json
"features": [
  { "level": 1, "name": "法术施放", "description": "..." },
  { "level": 1, "name": "奥术恢复", "description": "..." },
  { "level": 2, "name": "奥术传统", "description": "..." }
]
```
子职业特性单独存在 `subclasses.json` 中，前端合并展示。

## Risks / Trade-offs

| 风险 | 缓解措施 |
|------|---------|
| 玩家手册 HTML 结构不规则，特性解析可能漏字段 | 解析后人工抽查 3 个职业；CI 中加断言检查 features 数组非空 |
| `wizardStore` 结构变更破坏现有已保存的草稿数据 | 版本字段 `_v: 2` + 迁移函数，旧结构自动升级 |
| 多职业逻辑复杂（前提属性要求、施法等级合并） | 本次只实现等级分配和特性展示，施法槽合并规则推迟到法术变更 |
| 物品数量庞大（玩家手册第五章约 200+ 条目），解析耗时 | 分类分批解析；先保证背景用到的物品覆盖，其余物品可迭代补全 |

## Migration Plan

1. 先运行数据层脚本，生成新版 JSON 文件
2. 执行 `import_gamedata.py` 更新数据库（向后兼容，`update_or_create`）
3. 前端 `wizardStore` 加入版本迁移逻辑再部署
4. 回滚：旧 JSON 文件保留备份；`wizardStore` 降级只需清除 localStorage

## Open Questions

- Q1：多职业前提属性要求（如需要 13 点力量才能兼职战士）是否在向导中强制校验，还是仅展示提示？→ 建议本次仅展示警告，不阻止选择
- Q2：`parse_items.py` 的优先级：先解析背景用到的物品（约 50 条）还是整章全量解析（约 200 条）？→ 建议先全量，一次搞定
- Q3：角色卡预览是否需要支持打印/导出 PDF？→ 本次不支持，仅屏幕展示

# Character-Creation-Enhancement 开发计划

## 项目概述
基于 OpenSpec 规范完成 D&D 5e 角色创建向导的增强功能，实现多职业支持、技能熟练选择、背景物品展示和角色卡预览。

---

## 实施步骤

### 阶段 1：数据层建设

#### 1.1 物品数据库建设
- 新建 `backend/data/dnd5e_2014/items.json`（武器/护甲/冒险装备/工具）
- 在 Django `gamedata/models.py` 添加 `Item` 模型
- 更新 `import_gamedata.py` 物品导入逻辑

#### 1.2 职业数据补全
- 更新 `classes.json` 添加 `features`（按等级的特性列表）和 `skill_choices`（可选技能列表）
- 更新 Django `CharClass` 序列化器返回新字段
- 更新前端 `api.ts` 的 `CharClass` 类型定义

#### 1.3 背景数据补全
- 更新 `backgrounds.json` 补全 `feature_name`、`feature_description`、`starting_equipment`
- 更新 Django `Background` 序列化器
- 更新前端 `api.ts` 的 `Background` 类型定义

---

### 阶段 2：前端状态管理重构

#### 2.1 wizardStore 重构
- 将 `class_slug` 字段替换为 `classes: Array<{ class_slug: string; level: number }>`
- 添加 `chosen_skills: string[]` 字段
- 添加版本字段 `_v: 2` 实现旧数据迁移
- 实现 `allSkillProficiencies` 和 `totalLevel` selectors

#### 2.2 api.ts 类型更新
- 扩展 `CharClass` 接口：`features`、`skill_choices`、`starting_equipment`
- 扩展 `Background` 接口：`feature_description`、`starting_equipment`
- 新增 `Item` 类型定义

---

### 阶段 3：前端组件开发

#### 3.1 ClassSection 重构（职业步骤）
- 支持多职业条目（添加/删除兼职）
- 等级输入（1-20，总等级≤20）
- 技能熟练选择 UI（职业提供选择）
- 职业特性列表展示（按等级）
- ASI 节点醒目标注

#### 3.2 RaceSection 修复（种族步骤）
- 亚种族强制选择（有亚种族时）
- 亚种族属性加成合并
- 展示亚种族额外熟练项

#### 3.3 AbilityScoresSection 重构（属性步骤）
- 同屏展示分配方式和属性总览
- 实时计算最终属性值

#### 3.4 DescribeSection 优化（描述步骤）
- 背景技能全量展示（不截断）
- 背景特性真实数据展示
- 初始物品列表展示
- 角色名仅在此步骤填写

#### 3.5 CharacterPreview 组件（新增）
- 基本信息区（角色名、种族、职业等级、阵营等）
- 属性值区（最终值+调整值）
- 战斗数据区（熟练加值、HP 估算）
- 技能熟练区
- 背景与物品区
- 职业特性摘要区
- 数据不完整时的降级处理

#### 3.6 CreatePage 集成
- 调整步骤顺序：种族→职业→属性→描述→预览
- 角色名输入框从顶部移至描述步骤
- 集成 CharacterPreview 作为最后步骤

---

### 阶段 4：测试与验证

#### 4.1 单元测试
- wizardStore 状态迁移逻辑测试
- selector 计算逻辑测试
- API 类型检查

#### 4.2 集成测试
- 端到端角色创建流程测试
- 多职业场景测试（法师3级+圣武士2级）
- 数据完整性验证

---

## 关键文件清单

| 文件 | 操作 |
|------|------|
| `backend/data/dnd5e_2014/items.json` | 新建 |
| `backend/apps/gamedata/models.py` | 添加 Item 模型 |
| `backend/apps/gamedata/serializers.py` | 更新序列化器 |
| `backend/apps/gamedata/views.py` | 添加 Item API |
| `backend/scripts/import_gamedata.py` | 添加 Item 导入 |
| `frontend/src/stores/wizardStore.ts` | 重构状态管理 |
| `frontend/src/lib/api.ts` | 扩展类型定义 |
| `frontend/src/components/wizard/ClassSection.tsx` | 重构 |
| `frontend/src/components/wizard/RaceSection.tsx` | 修复 |
| `frontend/src/components/wizard/AbilityScoresSection.tsx` | 重构 |
| `frontend/src/components/wizard/DescribeSection.tsx` | 优化 |
| `frontend/src/components/wizard/CharacterPreview.tsx` | 新建 |
| `frontend/src/pages/CreatePage.tsx` | 集成调整 |

---

## 遵循的 OpenSpec 规范
- [character-wizard/spec.md](file:///d:/Workplace/dungeon-toolkit-web/openspec/changes/character-creation-enhancement/specs/character-wizard/spec.md)
- [race-subrace-selection/spec.md](file:///d:/Workplace/dungeon-toolkit-web/openspec/changes/character-creation-enhancement/specs/race-subrace-selection/spec.md)
- [class-features-display/spec.md](file:///d:/Workplace/dungeon-toolkit-web/openspec/changes/character-creation-enhancement/specs/class-features-display/spec.md)
- [multiclass-level-config/spec.md](file:///d:/Workplace/dungeon-toolkit-web/openspec/changes/character-creation-enhancement/specs/multiclass-level-config/spec.md)
- [skill-proficiency-selection/spec.md](file:///d:/Workplace/dungeon-toolkit-web/openspec/changes/character-creation-enhancement/specs/skill-proficiency-selection/spec.md)
- [background-display/spec.md](file:///d:/Workplace/dungeon-toolkit-web/openspec/changes/character-creation-enhancement/specs/background-display/spec.md)
- [starting-equipment-display/spec.md](file:///d:/Workplace/dungeon-toolkit-web/openspec/changes/character-creation-enhancement/specs/starting-equipment-display/spec.md)
- [character-sheet-preview/spec.md](file:///d:/Workplace/dungeon-toolkit-web/openspec/changes/character-creation-enhancement/specs/character-sheet-preview/spec.md)